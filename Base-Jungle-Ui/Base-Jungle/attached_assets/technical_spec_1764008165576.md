# Technical Specification: Passive DeFi Aggregator & Farming System (Base Blockchain)

## 1. Executive Summary
This document outlines the technical architecture for a fully automated, passive DeFi aggregation protocol on the **Base** blockchain. The system allows users to deposit assets (e.g., USDC, ETH) into "Master Vaults" which automatically manage yield generation across DEXs, Lending protocols, and Yield Farms.

**Core Value Proposition:**
- **Passive "Set & Forget":** Users deposit once; the system handles trading, rebalancing, and compounding.
- **Points-Based Incentives:** All on-chain activities (TVL, swaps, yield) generate "Points" which convert to protocol tokens at TGE.
- **Automated Leverage:** The system intelligently borrows funds to amplify yield for users.
- **Referral Matrix:** A tiered referral system that unlocks higher leverage ratios and point multipliers.

---

## 2. System Architecture

### 2.1 High-Level Diagram
```mermaid
graph TD
    User[User] -->|Deposit/Withdraw| Vault[Master Vault Contract]
    User -->|View Dashboard| API[Backend API]
    
    subgraph "On-Chain (Base)"
        Vault -->|Allocate| Strategy[Strategy Controller]
        Strategy -->|Swap| DEX[DEX Aggregator (Aerodrome/UniV3)]
        Strategy -->|Lend/Borrow| Lending[Lending Protocols (Aave/Moonwell)]
        Strategy -->|Farm| Farms[Yield Farms (Beefy/Convex)]
        
        Oracle[Price Oracles] --> Strategy
    end
    
    subgraph "Off-Chain Automation"
        Indexer[Event Indexer] -->|Track Events| DB[(Database)]
        Keeper[Keeper Bots] -->|Trigger Rebalance| Strategy
        Keeper -->|Harvest Rewards| Strategy
        PointsEngine[Points Engine] -->|Calculate| DB
    end
```

### 2.2 Technology Stack
- **Blockchain:** Base (L2)
- **Smart Contracts:** Solidity (Foundry/Hardhat)
- **Backend:** Node.js / Python (FastAPI)
- **Database:** PostgreSQL (User data, Points), Redis (Cache), TimescaleDB (TimeSeries)
- **Indexing:** The Graph (Subgraphs) or Ponder
- **Oracles:** Chainlink, Pyth

---

## 3. Smart Contract Modules

### 3.1 Master Vault (ERC-4626 Compliant)
The entry point for users. One vault per base asset (e.g., `vUSDC`, `vETH`).
- **Functions:**
  - `deposit(amount)`: Mints vault shares to user.
  - `withdraw(shares)`: Burns shares, returns principal + yield.
  - `totalAssets()`: Returns total managed value (Lending + Liquidity + Farms).

### 3.2 Strategy Controller
The "Brain" that manages asset allocation.
- **Logic:**
  - Maintains target allocation ratios (e.g., 40% Lending, 30% LP, 30% Leverage).
  - **`rebalance()`**: Moves funds between protocols based on APY signals.
  - **`harvest()`**: Claims reward tokens (e.g., AERO, WELL), swaps to base asset, and recompounds.

### 3.3 DEX Aggregator (Base Native)
Routes trades for yield strategies and user swaps.
- **Integrations:**
  - **Aerodrome:** Primary liquidity source on Base.
  - **Uniswap V3 (Base):** Concentrated liquidity.
  - **BaseSwap / SushiSwap:** Secondary routes.
- **Function:** `swap(tokenIn, tokenOut, amount)` -> Finds best route -> Executes.

### 3.4 Lending & Borrowing Manager
Handles automated leverage.
- **Integrations:** Aave V3 Base, Moonwell.
- **Logic:**
  - Checks **Health Factor** (HF) before any action.
  - **Leverage Loop:** Deposit Collateral -> Borrow Asset -> Deposit to Farm.
  - **Safety:** Auto-repay if HF drops below 1.2 (Target HF: 1.5 - 2.0).

---

## 4. Automation Layer (Keepers)

The system relies on off-chain bots ("Keepers") to trigger on-chain actions.

| Bot Name | Frequency | Responsibility |
|----------|-----------|----------------|
| **Opportunity Scanner** | 5 mins | Scans APYs across Aerodrome, Aave, Moonwell. Signals rebalance if spread > threshold. |
| **Rebalancer** | 1 hour | Executes `strategy.rebalance()` if signaled. Moves funds to highest yield. |
| **Harvester** | 24 hours | Calls `harvest()` on vaults. Claims rewards, swaps to base asset, compounds. |
| **Health Monitor** | **1 min** | Monitors LTV/Health Factor of leveraged positions. Triggers emergency repay if critical. |
| **Points Calculator** | Real-time/Hourly | Aggregates on-chain events to update user point balances. |

---

## 5. Points Farming System

Points are the pre-TGE incentive token. They are calculated off-chain (for gas efficiency) based on on-chain events.

### 5.1 Point Sources
1.  **TVL Points:** 1 Point per $1 USD value deposited per day.
2.  **Yield Points:** 2x Multiplier on yield earned (e.g., earn $10 yield -> get 20 points).
3.  **Activity Points:**
    - **Swaps:** 1 Point per $10 volume (automated or manual).
    - **Referrals:** 10% of referee's points.

### 5.2 Data Collection
- **Indexer:** Listens for `Deposit`, `Withdraw`, `Swap`, `Harvest` events.
- **Normalization:** Converts all token amounts to USD using historical price data at the time of transaction.

### 5.3 Staking & Lock-up Multipliers
Users can choose to "Stake" their Vault Shares (e.g., `vUSDC`) to earn a higher point rate. This commits the capital for a fixed duration.

| Lock Duration | Point Multiplier | Withdrawal Policy |
|---------------|------------------|-------------------|
| **Flexible**  | **1.0x**         | Anytime (Subject to Exit Fees) |
| **30 Days**   | **1.25x**        | Locked (Cannot Withdraw) |
| **90 Days**   | **1.50x**        | Locked (Cannot Withdraw) |
| **180 Days**  | **2.00x**        | Locked (Cannot Withdraw) |

- **Mechanism:** User calls `stake(amount, duration)`. The contract transfers `vUSDC` to a `StakingContract` which holds it until `block.timestamp >= unlockTime`.
- **Benefit:** Incentivizes long-term TVL retention.

---

## 6. Referral Matrix & Leverage System

A tiered system where referring active users unlocks **Financial Leverage** (higher yield potential) and **Social Leverage** (point multipliers).

### 6.1 The Matrix Structure

| Tier | Requirement | Point Multiplier (Social) | Max Strategy Leverage (Financial) |
|------|-------------|---------------------------|-----------------------------------|
| **Novice** | 0 Referrals | 1.0x | **1.5x** (Conservative) |
| **Scout** | 5 Active Refs | 1.1x | **2.0x** (Moderate) |
| **Captain** | 20 Active Refs | 1.25x | **3.0x** (Aggressive) |
| **Whale** | 50+ Active Refs | 1.5x | **5.0x** (Degen) |

### 6.2 "Financial Leverage" & Advanced Strategies Explained
This is a unique feature. Users with higher referral tiers authorize the **Strategy Controller** to take on higher risk/reward ratios for their specific share of the vault. This goes far beyond simple lending.

- **Mechanism:**
  - The Vault tracks `userTier` mapping.
  - When allocating funds for a user (conceptually), the strategy checks their Tier.
  - **Strategy Tiers:**
    - **Novice (Standard):**
        - **Lending:** Simple supply to Aave/Moonwell.
        - **Liquidity Provision (LP):** Stablecoin pairs only (e.g., USDC/DAI on Aerodrome).
        - **Farming:** Staking LP tokens for rewards.
    - **Captain/Whale (Aggressive):**
        - **Leveraged LP:** Borrow ETH to pair with USDC, providing 2x-3x more liquidity to Aerodrome pools.
        - **Delta-Neutral Farming:** Borrow volatile assets to hedge exposure while farming high-APY pools (e.g., Borrow ETH, LP in ETH-USDC, short ETH to neutralize price risk).
        - **Automated Trading:** Executing arbitrage trades between BaseSwap and Aerodrome using the user's idle capital.
  - *Note:* To keep gas low, this is likely implemented via **Sub-Vaults** (Conservative Vault, Aggressive Vault). Users are allowed to deposit into Aggressive Vaults only if they meet the Referral Tier requirement.

### 6.3 "Social Leverage" Explained
- **Direct Commission:** Earn 10% of points generated by direct referees.
- **Second-Tier:** Earn 5% of points from users referred by your referees.
- **Boost:** Your own point generation rate increases by the multiplier in the table above.

---

## 7. Detailed Strategy Breakdown

This section details the specific on-chain operations executed by the Strategy Controller.

### 7.1 Lending & Borrowing (Recursive)
- **Protocol:** Aave V3 Base, Moonwell.
- **Objective:** Earn interest + protocol rewards (e.g., WELL) + recursive leverage.
- **Mechanism:**
  1.  **Supply:** Deposit asset (e.g., USDC) to lending market.
  2.  **Borrow:** Borrow same asset against collateral (Looping).
  3.  **Re-Supply:** Deposit borrowed funds back to earn more supply APY.
  4.  **Net Result:** Multiplies the supply APY by the leverage factor (minus borrow cost).

### 7.2 Liquidity Provision (LP)
- **Protocol:** Aerodrome (Base's central liquidity hub).
- **Objective:** Earn trading fees + AERO emissions.
- **Types:**
  - **Stable LP (Novice):** Provide liquidity to USDC/DAI or USDC/USDbC. Minimal IL risk.
  - **Volatile LP (Aggressive):** Provide liquidity to WETH/USDC or AERO/USDC. Higher fee APY but carries IL risk.
  - **Leveraged LP:** Borrow ETH to pair with user's USDC to enter a WETH/USDC pool without selling the principal USDC.

### 7.3 Yield Farming
- **Protocol:** Beefy Finance, Convex (if available on Base), or direct MasterChef contracts.
- **Objective:** Auto-compound LP rewards.
- **Mechanism:**
  - Stake LP tokens (from Aerodrome) into the Farm.
  - **Auto-Harvest:** Keeper bot claims rewards (AERO) daily.
  - **Auto-Compound:** Swaps AERO -> USDC/ETH -> Adds more LP -> Re-stakes.

### 7.4 Automated Trading (Arbitrage)
- **Protocol:** Uniswap V3, BaseSwap, Aerodrome.
- **Objective:** Capture price discrepancies between DEXs.
- **Mechanism:**
  - **Scanner:** Bot detects price spread (e.g., ETH is $3000 on UniV3, $3010 on Aerodrome).
  - **Execution:** Flash loan (if needed) -> Buy Low -> Sell High.
  - **Profit:** Profit is returned to the Vault, increasing share value for all users.

---

## 8. Security & Risk Management

### 8.1 Smart Contract Risk
- **Audits:** Required for Vault and Strategy contracts.
- **Timelock:** 24-48 hour delay on strategy upgrades.
- **Guardians:** Multi-sig wallet capable of pausing deposits/withdrawals in emergency.

### 8.2 Financial Risk
- **Slippage Protection:** Hardcoded max slippage (e.g., 0.5%) on all automated swaps.
- **Liquidation Protection:**
  - Keepers maintain a buffer (e.g., 15%) above liquidation thresholds.
  - **Emergency Unwind:** If Health Factor drops rapidly, the system automatically unwinds the position (sells collateral/repays debt) to preserve principal.

---

## 9. User Scenario Example: The $100 Journey

To illustrate the system mechanics, here is a step-by-step walkthrough of a user ("Alice") interacting with the protocol.

### 9.1 Day 0: The Deposit
- **User:** Alice (Novice Tier, 0 Referrals).
- **Action:** Deposits **100 USDC** into the Master Vault.
- **System Action:**
  - **Allocation:** The Strategy Controller splits the $100 based on current optimal rates:
    - **$40** -> Lent on Moonwell (Supply APY: 5%).
    - **$30** -> Added to Aerodrome USDC/DAI Liquidity Pool (Stable LP, APY: 8%).
    - **$30** -> Deposited into a Beefy Finance Vault (Yield Farming, APY: 10%).
  - **Points:** Alice starts earning **TVL Points** immediately.

### 9.2 Day 1-29: Passive Accumulation
Alice does nothing. The system works 24/7.
- **Rebalancing:** On Day 12, Aave rates spike. The **Rebalancer Bot** moves the $40 from Moonwell to Aave.
- **Harvesting:** Every 24 hours, the **Harvester Bot** claims AERO and WELL rewards, swaps them for more USDC, and redeposits them (Compounding).
- **Point Accrual:**
  - **TVL Points:** 100 points/day * 30 days = **3,000 Points**.
  - **Yield Points:** Alice earns ~$0.60 in yield. Multiplier 2x = **1.2 Points** (negligible but tracks).
  - **Activity Points:** The system executed 2 rebalances on her behalf. 10 points each = **20 Points**.

### 9.3 Day 30: Withdrawal
- **Action:** Alice requests withdrawal.
- **System Action:**
  - Unwinds positions: Withdraws from Aave, Removes Liquidity from Aerodrome, Withdraws from Beefy.
  - Returns Principal + Yield.
- **Result:**
  - **Wallet:** Alice receives **$100.60 USDC** (approx 7% APY annualized).
  - **Dashboard:** Alice retains **3,021 Points** which will convert to tokens at TGE.

---

## 10. Revenue Model & Fee Structure

To ensure sustainability and profitability, the protocol applies the following fees to platform activities:

### 10.1 Performance Fee (Yield)
- **Rate:** 15% of all yield generated.
- **Mechanism:** Deducted automatically during the `harvest()` event before compounding.
- **Distribution:**
  - **10%** -> Protocol Treasury (Revenue).
  - **5%** -> Buyback & Burn (Token Value Accrual).

### 10.2 Withdrawal Fees & Early Exit Penalties
To protect long-term holders and prevent "mercenary farming," the protocol enforces strict penalties for early withdrawals.

| Holding Duration | Penalty Fee | Rationale |
|------------------|-------------|-----------|
| **< 24 Hours**   | **2.0%**    | Flash-farm prevention. |
| **< 7 Days**     | **1.0%**    | Short-term speculation discouragement. |
| **< 30 Days**    | **0.5%**    | Early exit fee. |
| **> 30 Days**    | **0.1%**    | Standard protocol fee (Gas/Admin). |

- **Mechanism:** The `withdraw()` function checks `block.timestamp - userDepositTime`.
- **Distribution of Penalties:**
  - **50%** -> Distributed to remaining Vault stakers (Yield Boost).
  - **50%** -> Protocol Treasury.

### 10.3 Aggregation Spread (Swaps)
- **Rate:** 0.05% on all swaps routed through the DEX Aggregator.
- **Mechanism:** Added to the price spread when the Strategy Controller executes swaps (e.g., Rebalancing, Harvesting).
- **Note:** This fee is internal but contributes to the protocol revenue.

### 10.4 Keeper / Gas Fee
- **Rate:** Variable (At Cost).
- **Mechanism:** A small portion of the harvested reward is sold to ETH to pay the Keeper bots for gas costs, ensuring the system remains autonomous and self-funding.

---

## 11. Deployment Roadmap (Base)

1.  **Phase 1: Core Contracts (Testnet)**
    - Deploy Vaults and simple Lending Strategy (Aave).
    - Basic Points Indexer.
2.  **Phase 2: Aggregation & Farms**
    - Integrate Aerodrome Router.
    - Add Beefy/Moonwell strategies.
3.  **Phase 3: Referral & Leverage**
    - Implement Tier logic.
    - Deploy "High Leverage" sub-vaults gated by referral count.
4.  **Phase 4: Mainnet Launch**
    - TGE (Token Generation Event) logic to convert Points -> Tokens.
